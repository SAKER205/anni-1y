<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kỷ Niệm 1 Năm ❤️</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --heart-color: #FF5CA4; --bg-soft: #ffeef2; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Quicksand', sans-serif; touch-action: manipulation; }

        /* MÀN 1: TRÁI TIM GỐC */
        #screen-1 { position: fixed; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 100; transition: opacity 1.5s; background: #000; }
        #pinkboard { position: relative; width: 100%; height: 100%; }
        .name-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); color: var(--heart-color); font-size: 1.8rem; font-family: 'Dancing Script', cursive; text-shadow: 0 0 15px var(--heart-color); z-index: 101; pointer-events: none; animation: textPulse 1.3s infinite; text-align: center; width: 100%; }

        #btn-start {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 15px 25px; border-radius: 50px; border: none; background: var(--heart-color);
            color: white; font-weight: bold; cursor: pointer; display: none; z-index: 150;
            box-shadow: 0 0 30px var(--heart-color); font-size: 1rem; width: 85%; max-width: 320px;
        }

        /* MÀN 2 & 3: BACKGROUND */
        #screen-2, #screen-3 { background: var(--bg-soft) url('https://www.transparenttextures.com/patterns/heart.png'); }
        #screen-2 { position: fixed; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 90; opacity: 0; transition: opacity 2s; flex-direction: column; }
        .chibi-img { width: 160px; max-width: 50%; animation: float 3s infinite ease-in-out; border-radius: 20px; }
        .dialog-box { background: white; padding: 15px; border-radius: 20px; margin-top: 20px; color: #d63384; font-weight: bold; text-align: center; width: 85%; border: 2px solid #ffcad4; box-shadow: 0 10px 20px rgba(0,0,0,0.05); font-size: 0.95rem; }

        #screen-3 { position: fixed; width: 100%; height: 100%; display: none; z-index: 80; overflow: hidden; }
        .memory-item {
            position: absolute; width: 140px; height: 140px; 
            object-fit: cover; border-radius: 15px; border: none !important; 
            box-shadow: 0 5px 15px rgba(214, 51, 132, 0.2);
            opacity: 0; transition: opacity 1.5s ease-in-out, transform 2s ease-in-out; z-index: 81;
        }

        /* MÀN 4: CUỘN THƯ */
        #screen-letter {
            position: fixed; width: 100%; height: 100%; display: none;
            justify-content: center; align-items: center; z-index: 200;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); transition: opacity 1.5s;
        }
        .scroll-container {
            width: 88%; max-width: 400px; background: #fdf5e6; padding: 25px 20px;
            border-radius: 8px; position: relative;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.1), 0 15px 40px rgba(0,0,0,0.6);
            max-height: 0; overflow: hidden; transition: max-height 2.5s ease-in-out;
            border-left: 10px solid #d4a76a; border-right: 10px solid #d4a76a;
            display: flex; flex-direction: column;
        }
        .scroll-container.open { max-height: 65vh; overflow-y: auto; }
        .letter-content { font-family: 'Dancing Script', cursive; font-size: 1.25rem; color: #5d4037; line-height: 1.7; text-align: center; white-space: pre-wrap; word-wrap: break-word; }
        .letter-content span { opacity: 0; transition: opacity 0.02s; }
        .letter-content span.visible { opacity: 1; }
        #scroll-anchor { height: 1px; width: 100%; flex-shrink: 0; }

        /* MÀN KẾT */
        #screen-final {
            position: fixed; width: 100%; height: 100%; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 300; background: #000; opacity: 0; transition: opacity 2.5s; overflow: hidden;
        }
        .final-bg {
            position: absolute; width: 100%; height: 100%;
            background: url('img/final_bg.jpg') center/cover no-repeat;
            filter: blur(4px) brightness(0.65); transform: scale(1.1);
        }
        .final-content { position: relative; z-index: 301; text-align: center; padding: 25px; width: 90%; }
        .final-text { font-family: 'Dancing Script', cursive; font-size: 1.8rem; color: #fff; text-shadow: 2px 2px 10px rgba(0,0,0,0.6); line-height: 1.5; }
        .floating-heart { position: absolute; color: #ff5ca4; pointer-events: none; animation: flyUp 4.5s linear forwards; opacity: 0.8; }

        @keyframes flyUp { to { transform: translateY(-115vh) rotate(360deg); opacity: 0; } }
        @keyframes textPulse { 0%, 100% { transform: translate(-50%, -55%) scale(1); } 50% { transform: translate(-50%, -55%) scale(1.05); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    </style>
</head>
<body>

    <audio id="bg-music" loop><source src="mot-doi.mp3" type="audio/mpeg"></audio>

    <div id="screen-1">
        <canvas id="pinkboard"></canvas>
        <div class="name-center">dvan ❤️ mhang</div>
    </div>

    <button id="btn-start"> Công chúa ơi! Giúp anh ấn vào đây nha ❤️</button>

    <div id="screen-2">
        <img src="chibidvan.jpg" class="chibi-img">
        <div class="dialog-box" id="talk">Chào công chúa của anh,</div>
    </div>

    <div id="screen-3"></div>

    <div id="screen-letter">
        <div class="scroll-container" id="scroll">
            <div class="letter-content" id="letter-text"></div>
            <div id="scroll-anchor"></div>
        </div>
    </div>

    <div id="screen-final">
        <div class="final-bg"></div>
        <div class="final-content">
            <div class="final-text">
                Cảm ơn mhang đã đọc những lời nhắn nhủ của anh.<br>
                Anh yêu em thật nhiều!<br>
                ❤️ Happy Anniversary ❤️
            </div>
        </div>
    </div>

    <script>
        /* --- KHÔI PHỤC TRÁI TIM GỐC --- */
        var settings = { particles: { length: 2000, duration: 2, velocity: 100, effect: -1.3, size: 13 } };
        (function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c[a]+"CancelAnimationFrame"]||window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(h,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));var g=window.setTimeout(function(){h(d+f)},f);b=d+f;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());
        var Point=(function(){function Point(x,y){this.x=(typeof x!=='undefined')?x:0;this.y=(typeof y!=='undefined')?y:0}Point.prototype.clone=function(){return new Point(this.x,this.y)};Point.prototype.length=function(length){if(typeof length=='undefined')return Math.sqrt(this.x*this.x+this.y*this.y);this.normalize();this.x/=length;this.y/=length;return this};Point.prototype.normalize=function(){var length=this.length();this.x/=length;this.y/=length;return this};return Point})();
        var Particle=(function(){function Particle(){this.position=new Point();this.velocity=new Point();this.acceleration=new Point();this.age=0}Particle.prototype.initialize=function(x,y,dx,dy){this.position.x=x;this.position.y=y;this.velocity.x=dx;this.velocity.y=dy;this.acceleration.x=dx*settings.particles.effect;this.acceleration.y=dy*settings.particles.effect;this.age=0};Particle.prototype.update=function(deltaTime){this.position.x+=this.velocity.x*deltaTime;this.position.y+=this.velocity.y*deltaTime;this.velocity.x+=this.acceleration.x*deltaTime;this.velocity.y+=this.acceleration.y*deltaTime;this.age+=deltaTime};Particle.prototype.draw=function(context,image){function ease(t){return(--t)*t*t+1}var size=image.width*ease(this.age/settings.particles.duration);context.globalAlpha=1-this.age/settings.particles.duration;context.drawImage(image,this.position.x-size/2,this.position.y-size/2,size,size)};return Particle})();
        var ParticlePool=(function(){var particles,firstActive=0,firstFree=0,duration=settings.particles.duration;function ParticlePool(length){particles=new Array(length);for(var i=0;i<particles.length;i++)particles[i]=new Particle()}ParticlePool.prototype.add=function(x,y,dx,dy){particles[firstFree].initialize(x,y,dx,dy);firstFree++;if(firstFree==particles.length)firstFree=0;if(firstActive==firstFree)firstActive++;if(firstActive==particles.length)firstActive=0};ParticlePool.prototype.update=function(deltaTime){var i;if(firstActive<firstFree){for(i=firstActive;i<firstFree;i++)particles[i].update(deltaTime)}if(firstFree<firstActive){for(i=firstActive;i<particles.length;i++)particles[i].update(deltaTime);for(i=0;i<firstFree;i++)particles[i].update(deltaTime)}while(particles[firstActive].age>=duration&&firstActive!=firstFree){firstActive++;if(firstActive==particles.length)firstActive=0}};ParticlePool.prototype.draw=function(context,image){if(firstActive<firstFree){for(i=firstActive;i<firstFree;i++)particles[i].draw(context,image)}if(firstFree<firstActive){for(i=firstActive;i<particles.length;i++)particles[i].draw(context,image);for(i=0;i<firstFree;i++)particles[i].draw(context,image)}};return ParticlePool})();
        (function(canvas){
            var context=canvas.getContext('2d'),particles=new ParticlePool(settings.particles.length),particleRate=settings.particles.length/settings.particles.duration,time;
            function pointOnHeart(t){return new Point(160*Math.pow(Math.sin(t),3),130*Math.cos(t)-50*Math.cos(2*t)-20*Math.cos(3*t)-10*Math.cos(4*t)+25)}
            var image=(function(){var canvas=document.createElement('canvas'),context=canvas.getContext('2d');canvas.width=settings.particles.size;canvas.height=settings.particles.size;function to(t){var point=pointOnHeart(t);point.x=settings.particles.size/2+point.x*settings.particles.size/350;point.y=settings.particles.size/2-point.y*settings.particles.size/350;return point}context.beginPath();var t=-Math.PI;var point=to(t);context.moveTo(point.x,point.y);while(t<Math.PI){t+=0.01;point=to(t);context.lineTo(point.x,point.y)}context.closePath();context.fillStyle='#FF5CA4';context.fill();var image=new Image();image.src=canvas.toDataURL();return image})();
            function render(){requestAnimationFrame(render);var newTime=new Date().getTime()/1000,deltaTime=newTime-(time||newTime);time=newTime;context.clearRect(0,0,canvas.width,canvas.height);var amount=particleRate*deltaTime;for(var i=0;i<amount;i++){var pos=pointOnHeart(Math.PI-2*Math.PI*Math.random());var dir=pos.clone().length(settings.particles.velocity);particles.add(canvas.width/2+pos.x,canvas.height/2-pos.y,dir.x,-dir.y)}particles.update(deltaTime);particles.draw(context,image)}
            function onResize(){canvas.width=canvas.clientWidth;canvas.height=canvas.clientHeight}window.onresize=onResize;setTimeout(onResize,10);render();
        })(document.getElementById('pinkboard'));

        /* --- LOGIC CHỐNG TRÙNG --- */
        let photoPool = Array.from({ length: 50 }, (_, i) => `img/${i + 1}.jpg`);
        const loveLetter = `Gửi mhang của anh\n\n Vậy là chúng ta đã bên nhau được một năm rồi đấy. Anh yêu em nhiều lắm. Anh hạnh phúc khi được cùng em đồng hành, cùng em chiêm nghiệm thế giới xung quanh. Có em đến bên đời, cuộc sống của anh có thêm nhiều màu sắc hơn, có thêm nhiều ý nghĩa hơn. Đặc biệt, em đã khiến anh cảm thấy được yêu là như thế nào. Anh không phải là người sâu sắc trong mọi hành động, đôi khi làm em phát bực, anh xin lỗi em vì những lần khó ưa của anh. Anh ước mong mình sẽ bên nhau thật lâu, thật lâu, vì anh yêu em, anh muốn được hạnh phúc cùng với em. Nếu mình sai thì cùng sửa, nếu có sóng gió thì cùng nhau vượt qua nhé em. Đoạn đường phía trước còn dài, anh sẽ bảo vệ và che chở em, cục cưng của anh ạ! \n\n Anh yêu em nhiều lắm ❤️\n\n Người yêu em, Trần Đức Văn`;

        const music = document.getElementById('bg-music');
        const btn = document.getElementById('btn-start');

        window.onload = () => { setTimeout(() => { btn.style.display = 'block'; }, 6000); }; // Trái tim hiện 6s

        btn.onclick = () => {
            music.play();
            btn.style.display = 'none';
            document.getElementById('screen-1').style.opacity = '0';
            setTimeout(() => { document.getElementById('screen-1').style.display = 'none'; startIntro(); }, 1000);
        };

        function startIntro() {
            const s2 = document.getElementById('screen-2');
            s2.style.display = 'flex';
            setTimeout(() => s2.style.opacity = '1', 100);
            const scripts = ["Mới ngày nào mình còn chập chững bên nhau", "Vậy mà đã 1 năm trôi qua rồi!", "Anh muốn gửi đến em hành trình của chúng ta", "Anh yêu em ❤️"];
            let i = 0;
            let timer = setInterval(() => {
                if (i < scripts.length) document.getElementById('talk').innerText = scripts[i++];
                else { clearInterval(timer); startMemories(); }
            }, 2500);
        }

        function startMemories() {
            document.getElementById('screen-2').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('screen-2').style.display = 'none';
                document.getElementById('screen-3').style.display = 'block';
                let flow = setInterval(() => {
                    if (photoPool.length > 0) {
                        let randomIndex = Math.floor(Math.random() * photoPool.length);
                        let imgSrc = photoPool.splice(randomIndex, 1)[0];
                        createMemory(imgSrc);
                    } else {
                        clearInterval(flow);
                        setTimeout(showScrollLetter, 3000);
                    }
                }, 1100);
            }, 1000);
        }

        function createMemory(imgSrc) {
            const item = document.createElement('img');
            item.className = 'memory-item';
            item.src = imgSrc;
            const sw = window.innerWidth - 150;
            const sh = window.innerHeight - 180;
            item.style.left = Math.random() * sw + 5 + 'px';
            item.style.top = Math.random() * sh + 5 + 'px';
            document.getElementById('screen-3').appendChild(item);
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = `scale(1) rotate(${Math.random() * 20 - 10}deg)`;
            }, 100);
            setTimeout(() => {
                item.style.opacity = '0';
                setTimeout(() => item.remove(), 1500);
            }, 3500);
        }

        function showScrollLetter() {
            document.getElementById('screen-3').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('screen-3').style.display = 'none';
                const sl = document.getElementById('screen-letter');
                sl.style.display = 'flex';
                const scroll = document.getElementById('scroll');
                scroll.scrollTop = 0;
                setTimeout(() => {
                    scroll.classList.add('open');
                    typeLetter(loveLetter, document.getElementById('letter-text'));
                }, 500);
            }, 1000);
        }

        function typeLetter(text, element) {
            const chars = text.split("");
            element.innerHTML = "";
            const anchor = document.getElementById('scroll-anchor');
            chars.forEach((char, index) => {
                const span = document.createElement("span");
                span.textContent = char;
                element.appendChild(span);
                setTimeout(() => {
                    span.classList.add('visible');
                    anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, index * 45);
            });
            setTimeout(showFinal, (chars.length * 45) + 5000);
        }

        function showFinal() {
            const sl = document.getElementById('screen-letter');
            document.getElementById('scroll').classList.remove('open');
            setTimeout(() => {
                sl.style.opacity = '0';
                setTimeout(() => {
                    sl.style.display = 'none';
                    const sf = document.getElementById('screen-final');
                    sf.style.display = 'flex';
                    setTimeout(() => { sf.style.opacity = '1'; spawnHearts(); }, 100);
                }, 1500);
            }, 1000);
        }

        function spawnHearts() {
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = '❤️';
                heart.style.left = Math.random() * 95 + 'vw';
                heart.style.fontSize = Math.random() * 15 + 15 + 'px';
                heart.style.bottom = '-50px';
                document.getElementById('screen-final').appendChild(heart);
                setTimeout(() => heart.remove(), 4500);
            }, 400);
        }
    </script>
</body>
</html>